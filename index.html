<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Safety Monitor v3</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        body { margin: 0; background: #121212; color: #e0e0e0; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        #status-box { width: 100%; height: 60px; background: #2e7d32; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; transition: 0.3s; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #ffffff33; }
        #video-container { width: 95%; max-width: 500px; margin-top: 15px; border-radius: 12px; overflow: hidden; border: 2px solid #333; background: #000; }
        video { width: 100%; display: block; transform: scaleX(-1); }
        #log-box { width: 90%; max-width: 480px; height: 100px; background: #000; margin-top: 10px; padding: 10px; overflow-y: auto; font-family: monospace; font-size: 12px; border: 1px solid #333; color: #00ff00; border-radius: 8px; }
        .controls { width: 90%; max-width: 480px; margin-top: 10px; background: #1e1e1e; padding: 15px; border-radius: 12px; box-sizing: border-box; }
        input[type=range] { width: 100%; height: 25px; }
        .alarm-active { background: #d32f2f !important; animation: pulse 0.6s infinite; }
        @keyframes pulse { 0% { background-color: #d32f2f; } 50% { background-color: #ff5252; } 100% { background-color: #d32f2f; } }
        .btn-group { display: flex; gap: 10px; margin: 15px 0; width: 90%; max-width: 480px; }
        button { flex: 1; padding: 15px; font-size: 16px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; }
        #start-btn { background: #2196f3; color: white; }
        #reset-btn { background: #555; color: white; display: none; }
    </style>
</head>
<body>

    <div id="status-box">SYSTEM READY</div>

    <div id="video-container">
        <video id="input_video" playsinline></video>
    </div>

    <div class="btn-group">
        <button id="start-btn">START CAMERA</button>
        <button id="reset-btn">RESET ALARM</button>
    </div>

    <div id="log-box">Logs:<br>> Waiting to start...</div>

    <div class="controls">
        <label>AI Sensitivity: <span id="sens-val" style="color:#2196f3;">0.5</span></label>
        <input type="range" id="sensitivity" min="0.1" max="0.9" step="0.1" value="0.5">
    </div>

    <audio id="alarm" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" loop></audio>

    <script>
        const videoElement = document.getElementById('input_video');
        const statusBox = document.getElementById('status-box');
        const logBox = document.getElementById('log-box');
        const alarm = document.getElementById('alarm');
        const startBtn = document.getElementById('start-btn');
        const resetBtn = document.getElementById('reset-btn');
        const sensSlider = document.getElementById('sensitivity');
        const sensDisplay = document.getElementById('sens-val');
        
        let signalCount = 0;
        let isCurrentlySignaling = false;

        sensSlider.oninput = function() {
            sensDisplay.innerText = this.value;
            hands.setOptions({ minDetectionConfidence: parseFloat(this.value) });
        };

        function addLog(msg) {
            logBox.innerHTML += `<br>> ${msg}`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        function onResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const hand = results.multiHandLandmarks[0];
                const thumbTucked = hand[4].x > hand[13].x; 
                const fingersFolded = hand[8].y > hand[6].y && hand[12].y > hand[10].y;

                if (thumbTucked && fingersFolded) {
                    if (!isCurrentlySignaling) {
                        isCurrentlySignaling = true;
                        signalCount++;
                        handleDetection();
                    }
                } else {
                    if (isCurrentlySignaling) {
                        isCurrentlySignaling = false;
                        if (signalCount < 4) {
                            statusBox.style.background = "#2e7d32";
                            statusBox.innerText = "MONITORING...";
                        }
                    }
                }
            }
        }

        function handleDetection() {
            statusBox.style.background = "#d32f2f";
            statusBox.innerText = "SIGNAL DETECTED";
            addLog(`Signal #${signalCount} identified.`);
            
            if (signalCount === 4) {
                addLog(`ALARM TRIGGERED!`);
                alarm.play();
                statusBox.classList.add('alarm-active');
                resetBtn.style.display = "block";
            }
        }

        resetBtn.addEventListener('click', () => {
            alarm.pause();
            alarm.currentTime = 0;
            signalCount = 0;
            statusBox.classList.remove('alarm-active');
            statusBox.style.background = "#2e7d32";
            statusBox.innerText = "MONITORING...";
            resetBtn.style.display = "none";
            addLog("System Reset.");
        });

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 480, height: 360,
            facingMode: 'user' // Forces front camera on mobile
        });
        
        startBtn.addEventListener('click', () => {
            camera.start();
            startBtn.style.display = 'none';
            addLog("Camera active.");
        });
    </script>
</body>
</html>
